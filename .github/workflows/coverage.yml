name: Coverage

on:
  # pull_request:
  #   branches:
  #     - develop
  #     - master
  push:
    # tags:
    #   - '*'
    branches:
      - duty/codecov
jobs:
  coverage:
    runs-on: ubuntu-latest
    container:
      image: sora2/substrate:env
    env:
      CARGO_INCREMENTAL: 0
      SKIP_WASM_BUILD: 1
      LLVM_PROFILE_FILE: "sora2-%p-%m.profraw"
      RUST_BACKTRACE: short
      RUSTFLAGS: "-Cinstrument-coverage"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - uses: Swatinem/rust-cache@v2
      - name: Run tests, with coverage
        run: |
          cargo test --features "kusama,polkadot,rococo,runtime-benchmarks"
          grcov . --binary-path ./target/debug -s . -t cobertura --branch -o ./cobertura_report --ignore-not-existing --ignore  "/opt/cargo/**" "target/debug" "node/src" --log-level "ERROR" --llvm-path /usr/lib/llvm-14/bin
          find . -type f -name '*.profraw' -delete

      - name: Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false